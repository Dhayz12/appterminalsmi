<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Pemberangkatan Bis - TTA Sukabumi</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            padding-bottom: 80px; /* Space for footer */
        }
        
        /* Slide Animation */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #1e3a8a; 
            border-radius: 4px;
        }

        /* Print Styling */
        @media print {
            body {
                padding-top: 0;
                padding-bottom: 0;
                background-color: white;
            }
            header, footer, .no-print, #loginSection, #waButton {
                display: none !important;
            }
            .print-container {
                margin-top: 0 !important;
            }
            .card-item {
                break-inside: avoid;
                border: 1px solid #ddd;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>

    <!-- LOGIN SECTION -->
    <section id="loginSection" class="fixed inset-0 bg-blue-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden relative">
            <!-- Login Header with Logos -->
            <div class="bg-blue-800 p-4">
                <div class="flex justify-between items-center mb-2">
                    <img src="images/logoperhub.png" class="h-12 w-12 object-contain filter drop-shadow-sm">
                    <img src="images/logohubdat.png" class="h-12 w-12 object-contain filter drop-shadow-sm">
                </div>
                <div class="text-center">
                    <h2 class="text-white text-xl font-bold uppercase tracking-wide">Login System</h2>
                    <p class="text-blue-200 text-sm">Satuan Pelayanan Terminal Tipe A Sukabumi</p>
                </div>
            </div>
            
            <div class="p-6">
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                                <i class="fas fa-user"></i>
                            </span>
                            <input type="text" id="username" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan username">
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                                <i class="fas fa-lock"></i>
                            </span>
                            <input type="password" id="password" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-900 text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition transform active:scale-95 shadow-lg mb-4">
                        MASUK <i class="fas fa-sign-in-alt ml-2"></i>
                    </button>
                </form>

                <!-- Login Marquee -->
                <div class="mb-4 bg-yellow-100 text-yellow-800 p-2 rounded text-xs border border-yellow-200 overflow-hidden">
                    <marquee behavior="scroll" direction="left">
                        Untuk akses ke menu dashboard hubungi CS jika Anda lupa password atau belum memiliki akun.
                    </marquee>
                </div>

                <!-- Login WA Button -->
                <a href="https://wa.me/628123456789" target="_blank" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition flex items-center justify-center gap-2 shadow-md">
                    <i class="fab fa-whatsapp text-xl"></i> Hubungi CS
                </a>
            </div>
            <div class="bg-gray-50 p-4 text-center text-xs text-gray-500 border-t">
                &copy; Copyright 2025
            </div>
        </div>
    </section>

    <!-- MAIN APP (Hidden initially) -->
    <div id="mainApp" class="hidden">

        <!-- 1. Header Fixed Warna Biru Tua -->
        <header class="fixed top-0 left-0 w-full bg-blue-900 text-white z-50 shadow-lg">
            <div class="container mx-auto px-2 py-2 md:py-3 flex justify-between items-center">
                <!-- Logo Kiri -->
                <div class="cursor-pointer hover:opacity-80 transition" onclick="showCreatorInfo()">
                    <img src="images/logoperhub.png" alt="Dishub" class="h-10 w-10 md:h-12 md:w-12 object-contain drop-shadow-md">
                </div>

                <!-- Text Tengah -->
                <div class="flex-grow text-center mx-2">
                    <h1 class="text-base md:text-lg font-bold uppercase tracking-wide leading-tight">
                        Jadwal Pemberangkatan
                    </h1>
                    <div class="text-[10px] md:text-xs font-light tracking-wider">Terminal Tipe A Sukabumi</div>
                </div>

                <!-- Logo Kanan -->
                <div>
                    <img src="images/logohubdat.png" alt="Sukabumi" class="h-10 w-10 md:h-12 md:w-12 object-contain drop-shadow-md">
                </div>
            </div>
        </header>

        <!-- 11. Text Marquee Kecil -->
        <div class="mt-16 bg-blue-800 text-white text-sm py-1 border-b border-blue-700 overflow-hidden no-print">
            <div class="flex items-center">
                <div class="bg-blue-900 px-3 py-1 z-10 font-bold whitespace-nowrap shadow-md">
                    <i class="fas fa-bullhorn text-yellow-400 mr-2"></i> INFO
                </div>
                <marquee class="py-1 flex-1 w-full" behavior="scroll" direction="left">
                    <i class="fas fa-info-circle mx-2"></i> Satuan Pelayanan Terminal Tipe A Sukabumi - Selalu utamakan keselamatan dan kenyamanan penumpang.
                    <i class="fas fa-clock mx-2"></i> Datanglah 15 menit sebelum keberangkatan.
                </marquee>
            </div>
        </div>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6 print-container">
            
            <!-- 2. Images Slide -->
            <div class="relative w-full h-48 md:h-64 rounded-xl overflow-hidden shadow-lg mb-6 no-print group">
                <img id="sliderImage" src="https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?q=80&w=1000&auto=format&fit=crop" alt="Bus Station" class="w-full h-full object-cover transition-transform duration-700 hover:scale-105">
                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/70 to-transparent p-4">
                    <h2 class="text-white text-lg font-bold"> - </h2>
                    <p class="text-gray-200 text-sm">Melayani dengan Sepenuh Hati</p>
                </div>
                <!-- Slider Controls -->
                <button onclick="prevSlide()" class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black/30 hover:bg-black/50 text-white p-2 rounded-full transition"><i class="fas fa-chevron-left"></i></button>
                <button onclick="nextSlide()" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black/30 hover:bg-black/50 text-white p-2 rounded-full transition"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- 3. Info Box Text Kecil -->
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-6 rounded shadow-sm text-sm flex items-center no-print">
                <i class="fas fa-exclamation-triangle mr-3 text-lg"></i>
                <p><strong>Perhatian:</strong> Jadwal sewaktu-waktu bisa berubah tergantung kondisi lalu lintas dan operasional armada.</p>
            </div>

            <!-- Toolbar: Search & Buttons -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-white p-4 rounded-lg shadow-md no-print">
                <!-- 5. Kolom Pencarian -->
                <div class="relative w-full md:w-1/3">
                    <input type="text" id="searchInput" onkeyup="searchSchedule()" placeholder="Cari Jurusan atau Bis..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>

                <!-- 6. Buttons: Tambah, Backup, Restore, Cetak -->
                <div class="grid grid-cols-2 md:flex md:flex-row gap-2 w-full md:w-auto">
                    <button id="btnAdd" onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center shadow w-full md:w-auto">
                        <i class="fas fa-plus mr-2"></i> Tambah
                    </button>
                    <button id="btnBackup" onclick="backupData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center shadow w-full md:w-auto">
                        <i class="fas fa-download mr-2"></i> Backup
                    </button>
                    <button id="btnRestore" onclick="triggerRestore()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition flex items-center justify-center shadow w-full md:w-auto">
                        <i class="fas fa-upload mr-2"></i> Restore
                    </button>
                    <input type="file" id="restoreInput" class="hidden" onchange="restoreData(this)">
                    <button id="btnPrint" onclick="showPrintOptions()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg transition flex items-center justify-center shadow w-full md:w-auto">
                        <i class="fas fa-print mr-2"></i> Cetak
                    </button>
                </div>
            </div>

            <!-- 7. Hasil Input Menggunakan Kartu -->
            <div id="scheduleGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Cards will be injected here by JS -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-10">
                <div class="text-gray-400 mb-4">
                    <i class="fas fa-bus fa-4x"></i>
                </div>
                <p class="text-gray-500 text-lg">Belum ada data jadwal.</p>
            </div>
            
            <!-- Logout Button (Optional but useful) -->
            <div class="flex justify-center mt-8 no-print">
                 <button onclick="handleLogout()" class="text-red-500 text-sm hover:underline"><i class="fas fa-sign-out-alt"></i> Keluar</button>
            </div>

        </main>

        <!-- Floating WhatsApp Button -->
        <a id="waButton" href="https://wa.me/628123456789" target="_blank" class="fixed bottom-16 right-4 z-[60] bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-full shadow-2xl flex items-center gap-2 transition-transform hover:scale-105 no-print border-2 border-white">
            <i class="fab fa-whatsapp text-2xl"></i>
            <span class="font-bold text-sm">Hubungi CS</span>
        </a>

        <!-- 10. Footer Fixed Warna Biru Tua -->
        <footer class="fixed bottom-0 left-0 w-full bg-blue-900 text-white py-3 z-50 shadow-inner-top">
            <div class="container mx-auto text-center">
                <p class="font-bold tracking-wide">TTA SUKABUMI &copy; 2025</p>
            </div>
        </footer>

        <!-- Modal Form (Hidden by default) -->
        <div id="modalForm" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg m-4 transform transition-all scale-100">
                <div class="bg-blue-900 text-white px-6 py-4 rounded-t-xl flex justify-between items-center">
                    <h3 id="modalTitle" class="text-xl font-bold">Tambah Jadwal</h3>
                    <button onclick="closeModal()" class="text-white hover:text-gray-300 focus:outline-none">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <form id="busForm" onsubmit="saveData(event)">
                        <input type="hidden" id="editId">
                        
                        <!-- 4. Format CRUD Fields -->
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Nama Bus</label>
                            <input type="text" id="busName" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Kosongkan jika tidak tersedia">
                            <p class="text-xs text-red-500 mt-1">*Jika dikosongkan, status menjadi 'Tidak Tersedia'</p>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Jurusan</label>
                            <input type="text" id="route" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Bandung">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Jam -->
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Jam Pemberangkatan</label>
                                <div class="flex items-center gap-2">
                                    <div class="relative w-full">
                                        <input type="time" id="timeStart" required class="w-full px-2 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    </div>
                                    <span class="text-xs font-bold text-gray-500">s/d</span>
                                    <div class="relative w-full">
                                        <input type="time" id="timeEnd" class="w-full px-2 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    </div>
                                </div>
                            </div>
                            <!-- Tarif -->
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Tarif (Rp)</label>
                                <input type="number" id="fare" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder=" ">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Jenis Armada</label>
                            <div class="flex gap-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="busType" value="AKDP" checked class="mr-2 text-blue-600 focus:ring-blue-500">
                                    AKDP
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="busType" value="AKAP" class="mr-2 text-blue-600 focus:ring-blue-500">
                                    AKAP
                                </label>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Keterangan</label>
                            <textarea id="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder=" "></textarea>
                        </div>

                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-900 text-white rounded hover:bg-blue-800 transition shadow">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Authentication Logic ---
        let currentUserRole = null; // 'admin' or 'user' or null

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            if (u === 'admin' && p === 'admin') {
                loginSuccess('admin');
            } else if (u === 'ttasmi' && p === 'smi1234') {
                loginSuccess('user');
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Masuk',
                    text: 'Username atau Password salah!',
                    confirmButtonColor: '#1e3a8a'
                });
            }
        }

        function loginSuccess(role) {
            currentUserRole = role;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Clear input
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            // Update UI based on Role
            updateUIByRole();
            
            // Load Data from Server
            fetchServerData();

            // Toast
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            Toast.fire({
                icon: 'success',
                title: `Selamat Datang, ${role === 'admin' ? 'Admin' : 'Petugas'}!`
            });
        }

        function handleLogout() {
            Swal.fire({
                title: 'Keluar?',
                text: "Anda akan kembali ke halaman login",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#1e3a8a',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, Keluar'
            }).then((result) => {
                if (result.isConfirmed) {
                    currentUserRole = null;
                    document.getElementById('mainApp').classList.add('hidden');
                    document.getElementById('loginSection').classList.remove('hidden');
                }
            });
        }

        function updateUIByRole() {
            const btnAdd = document.getElementById('btnAdd');
            const btnBackup = document.getElementById('btnBackup');
            
            if (currentUserRole === 'user') {
                // User: Can only Restore & Print
                btnAdd.classList.add('hidden');
                btnBackup.classList.add('hidden');
                btnRestore.classList.add('hidden');
                btnPrint.classList.add('hidden');
                
            } else {
                // Admin: Full Access
                btnAdd.classList.remove('hidden');
                btnBackup.classList.remove('hidden');
                btnRestore.classList.remove('hidden');
                btnPrint.classList.remove('hidden');  
                
            }
        }

        // --- Creator Info ---
        function showCreatorInfo() {
            Swal.fire({
                title: '<strong>Info Creator</strong>',
                html: `
                    <div class="flex flex-col items-center mt-2">
                        <div class="w-32 h-32 mb-4 relative">
                            <img src="images/foto1.png" alt="Yudha Samudra" class="w-full h-full rounded-full shadow-lg border-4 border-blue-900 object-cover">
                            <div class="absolute bottom-0 right-0 bg-white rounded-full p-1 border border-gray-200">
                                <i class="fas fa-check-circle text-blue-500 text-xl"></i>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">Yudha Samudra, A. M. d</h3>
                        <div class="mt-2 text-center">
                            <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-blue-200">NIP: 198508122025211024</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-2 font-medium">Jabatan:</p>
                        <p class="text-gray-800 font-bold">PPPK (Pengelola Layanan Operasional)</p>
                    </div>
                `,
                showCloseButton: true,
                showConfirmButton: false,
                focusConfirm: false,
                background: '#ffffff',
                customClass: {
                    popup: 'rounded-3xl shadow-2xl',
                    backdrop: 'backdrop-blur-md bg-slate-900/40'
                }
           
 
           });
        }

        // --- Image Slider Logic ---
        const images = [
        "images/logo1.jpg",
            "images/img(1).jpg",
             "images/img(2).jpg",
              "images/img(3).jpg",
               "images/img(4).jpg",
                "images/img(5).jpg",
                 "images/img(6).jpg",
                  "images/img(7).jpg",
                   "images/img(8).jpg",
                    "images/img(9).jpg",
            
        ];
        let currentImageIndex = 0;
        const sliderImgElement = document.getElementById('sliderImage');

        function showSlide(index) {
            sliderImgElement.classList.remove('fade-in');
            void sliderImgElement.offsetWidth; // Trigger reflow
            sliderImgElement.src = images[index];
            sliderImgElement.classList.add('fade-in');
        }

        function nextSlide() {
            currentImageIndex = (currentImageIndex + 1) % images.length;
            showSlide(currentImageIndex);
        }

        function prevSlide() {
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            showSlide(currentImageIndex);
        }

        // Auto slide every 5 seconds
        setInterval(nextSlide, 5000);

        // --- CRUD Logic ---
        let scheduleData = JSON.parse(localStorage.getItem('busScheduleData')) || [];

        // Data cadangan jika fetch gagal (misal dibuka tanpa server local)
        const fallbackData = [
          { "id": "1", "busName": "MGI", "route": "Sukabumi - Bandung", "timeStart": "05:00", "timeEnd": "06:00", "fare": 45000, "type": "AKDP", "description": "Via Cianjur - Padalarang" },
          { "id": "2", "busName": "Hiba Putra", "route": "Sukabumi - Yogyakarta", "timeStart": "13:00", "timeEnd": "", "fare": 180000, "type": "AKAP", "description": "Eksekutif Class, Free Makan" },
          { "id": "3", "busName": "Sinar Jaya", "route": "Sukabumi - Bekasi", "timeStart": "06:00", "timeEnd": "17:00", "fare": 60000, "type": "AKDP", "description": "Via Tol Bocimi" },
          { "id": "4", "busName": "", "route": "Sukabumi - Cirebon", "timeStart": "08:00", "timeEnd": "", "fare": 100000, "type": "AKDP", "description": "Armada sedang dalam perbaikan" },
          { "id": "5", "busName": "Budiman", "route": "Sukabumi - Pangandaran", "timeStart": "07:30", "timeEnd": "19:00", "fare": 120000, "type": "AKDP", "description": "Lewat Tasikmalaya" },
          { "id": "6", "busName": "Tunggal Daya", "route": "Sukabumi - Wonogiri", "timeStart": "11:00", "timeEnd": "", "fare": 210000, "type": "AKAP", "description": "Full AC Toilet" }
        ];

        async function fetchServerData() {
            try {
                // Gunakan timestamp untuk menghindari cache browser
                const response = await fetch('data_jadwal_bus.json?' + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const serverData = await response.json();
                
                // Jika berhasil load dari JSON, gunakan data tersebut
                scheduleData = serverData;
                localStorage.setItem('busScheduleData', JSON.stringify(scheduleData));
                renderCards();
                
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
                Toast.fire({ icon: 'success', title: 'Wilujeung Sumping, Sinkronisasi data' });

            } catch (error) {
                console.error('Gagal memuat data server:', error);
                
                // JIKA GAGAL (Mungkin karena CORS/File Protocol), gunakan Fallback Data
                // agar user tetap melihat sesuatu dan tidak kosong.
                if (scheduleData.length === 0) {
                    scheduleData = fallbackData;
                    localStorage.setItem('busScheduleData', JSON.stringify(scheduleData));
                    renderCards();
                    
                    Swal.fire({
                        icon: 'info',
                        title: 'Mode Offline',
                        text: 'Gagal membaca file data_jadwal_bus.json (Browser memblokir akses file lokal). Data default ditampilkan.',
                        confirmButtonColor: '#1e3a8a'
                    });
                }
            }
        }

        function renderCards(dataToRender = scheduleData) {
            const grid = document.getElementById('scheduleGrid');
            const emptyState = document.getElementById('emptyState');
            grid.innerHTML = '';

            if (dataToRender.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            dataToRender.forEach(item => {
                // Status Logic
                const hasBus = item.busName && item.busName.trim() !== '';
                const statusColor = hasBus ? 'bg-green-500' : 'bg-red-500';
                const statusText = hasBus ? 'Tersedia' : 'Tidak Tersedia';
                const busDisplayName = hasBus ? item.busName : '<span class="italic text-gray-400">Belum ada armada</span>';
                
                // Format Rupiah
                const formattedFare = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(item.fare);

                // Format Time
                let displayTime = item.time || '';
                if (item.timeStart) {
                    displayTime = item.timeStart;
                    if (item.timeEnd) {
                        displayTime += ' s/d ' + item.timeEnd;
                    }
                }
                displayTime += ' WIB';

                // Determine Badge Color based on Type
                let typeBadgeClass = 'bg-gray-100 text-gray-800 border-gray-200';
                if (item.type === 'AKAP') {
                    typeBadgeClass = 'bg-purple-100 text-purple-800 border-purple-200';
                } else if (item.type === 'AKDP') {
                    typeBadgeClass = 'bg-cyan-100 text-cyan-800 border-cyan-200';
                }

                // Action Buttons (Only for Admin)
                let actionButtonsHTML = '';
                if (currentUserRole === 'admin') {
                    actionButtonsHTML = `
                        <div class="bg-gray-50 px-5 py-3 border-t border-gray-100 flex justify-end gap-2 no-print">
                            <button onclick="editBus('${item.id}')" class="text-blue-600 hover:text-blue-800 transition" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteBus('${item.id}')" class="text-red-600 hover:text-red-800 transition" title="Hapus">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                }

                const card = document.createElement('div');
                card.className = 'card-item bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition relative border border-gray-100 flex flex-col h-full';
                card.innerHTML = `
                    <div class="h-2 w-full ${hasBus ? 'bg-blue-600' : 'bg-gray-400'}"></div>
                    <div class="p-5 flex-grow">
                        <!-- Status Indicator -->
                        <div class="absolute top-4 right-4 flex items-center gap-2" title="${statusText}">
                            <span class="text-xs font-semibold text-gray-500">${statusText}</span>
                            <div class="w-3 h-3 rounded-full ${statusColor} shadow-sm animate-pulse"></div>
                        </div>

                        <h3 class="text-lg font-bold text-gray-800 mb-1 pr-16">${item.route}</h3>
                        <p class="text-blue-700 font-semibold mb-3 flex items-center">
                            <i class="fas fa-bus mr-2"></i> ${busDisplayName}
                        </p>

                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span><i class="far fa-clock text-blue-400 mr-2"></i> Jam</span>
                                <span class="font-medium">${displayTime}</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span><i class="fas fa-money-bill-wave text-green-500 mr-2"></i> Tarif</span>
                                <span class="font-medium">${formattedFare}</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span><i class="fas fa-road text-gray-500 mr-2"></i> Jenis</span>
                                <span class="${typeBadgeClass} border text-xs px-2 py-0.5 rounded-full font-bold">${item.type}</span>
                            </div>
                            <div class="pt-2">
                                <p class="text-xs text-gray-500 italic"><i class="fas fa-info-circle mr-1"></i> ${item.description || '-'}</p>
                            </div>
                        </div>
                    </div>
                    ${actionButtonsHTML}
                `;
                grid.appendChild(card);
            });
        }

        // --- Modal Functions ---
        const modal = document.getElementById('modalForm');
        
        function openModal(editItem = null) {
            modal.classList.remove('hidden');
            if (editItem) {
                document.getElementById('modalTitle').innerText = 'Edit Jadwal';
                document.getElementById('editId').value = editItem.id;
                document.getElementById('busName').value = editItem.busName;
                document.getElementById('route').value = editItem.route;
                
                // Time
                document.getElementById('timeStart').value = editItem.timeStart || editItem.time;
                document.getElementById('timeEnd').value = editItem.timeEnd || '';

                document.getElementById('fare').value = editItem.fare;
                document.getElementById('description').value = editItem.description;
                
                // Radio button logic
                const radios = document.getElementsByName('busType');
                for(let r of radios) {
                    if(r.value === editItem.type) r.checked = true;
                }
            } else {
                document.getElementById('modalTitle').innerText = 'Tambah Jadwal';
                document.getElementById('busForm').reset();
                // Default value for Route
                document.getElementById('route').value = 'Sukabumi - ';
                document.getElementById('editId').value = '';
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeModal();
        });

        // --- Save Data ---
        function saveData(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const busName = document.getElementById('busName').value;
            const route = document.getElementById('route').value;
            
            const timeStart = document.getElementById('timeStart').value;
            const timeEnd = document.getElementById('timeEnd').value;
            
            const fare = document.getElementById('fare').value;
            const description = document.getElementById('description').value;
            
            // Get Radio Value
            let type = '';
            const radios = document.getElementsByName('busType');
            for(let r of radios) {
                if(r.checked) type = r.value;
            }

            const itemData = {
                id: id || Date.now().toString(),
                busName,
                route,
                timeStart,
                timeEnd,
                fare,
                type,
                description
            };

            if (id) {
                // Edit
                const index = scheduleData.findIndex(item => item.id === id);
                if (index !== -1) {
                    scheduleData[index] = itemData;
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: 'Data jadwal berhasil diperbarui.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            } else {
                // Add New
                scheduleData.push(itemData);
                Swal.fire({
                    icon: 'success',
                    title: 'Ditambahkan!',
                    text: 'Jadwal baru berhasil ditambahkan.',
                    timer: 1500,
                    showConfirmButton: false
                });
            }

            localStorage.setItem('busScheduleData', JSON.stringify(scheduleData));
            renderCards();
            closeModal();
        }

        // --- Edit & Delete ---
        function editBus(id) {
            const item = scheduleData.find(d => d.id === id);
            if (item) openModal(item);
        }

        function deleteBus(id) {
            Swal.fire({
                title: 'Apakah anda yakin?',
                text: "Data yang dihapus tidak dapat dikembalikan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, hapus!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    scheduleData = scheduleData.filter(item => item.id !== id);
                    localStorage.setItem('busScheduleData', JSON.stringify(scheduleData));
                    renderCards();
                    Swal.fire(
                        'Terhapus!',
                        'Data jadwal telah dihapus.',
                        'success'
                    );
                }
            });
        }

        // --- 5. Pencarian ---
        function searchSchedule() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filteredData = scheduleData.filter(item => 
                item.route.toLowerCase().includes(query) || 
                item.busName.toLowerCase().includes(query)
            );
            renderCards(filteredData);
        }

        // --- 6. Backup & Restore ---
        function backupData() {
            if (scheduleData.length === 0) {
                Swal.fire('Info', 'Tidak ada data untuk dibackup', 'info');
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scheduleData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "jadwal_bus_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            Swal.fire({
                icon: 'success',
                title: 'Backup Berhasil',
                text: 'File backup telah diunduh.',
                timer: 1500,
                showConfirmButton: false
            });
        }

        function triggerRestore() {
            document.getElementById('restoreInput').click();
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        scheduleData = data;
                        localStorage.setItem('busScheduleData', JSON.stringify(scheduleData));
                        renderCards();
                        Swal.fire('Sukses', 'Data berhasil direstore!', 'success');
                    } else {
                        throw new Error('Format salah');
                    }
                } catch (error) {
                    Swal.fire('Error', 'File backup tidak valid!', 'error');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        // --- Print ---
    function showPrintOptions() {
    Swal.fire({
        title: '<strong>Pilih Opsi Cetak</strong>',
        html:
            '<p class="text-[11px] italic text-blue-800 text-center mt-1 flex items-center justify-center gap-1">' +
            '<i class="fas fa-file-pdf text-red-600"></i>' +
            'Pilih salah satu kategori untuk mengunduh file PDF' +
            '</p>' +

            '<div class="flex flex-col gap-3 mt-4 text-left">' +

            '<button onclick="printByCategory(\'all\')" class="bg-blue-600 text-white py-3 px-4 rounded hover:bg-blue-700 transition flex items-center shadow">' +
            '<i class="fas fa-list w-8"></i> Cetak Semua</button>' +

            '<button onclick="printByCategory(\'AKDP\')" class="bg-green-600 text-white py-3 px-4 rounded hover:bg-green-700 transition flex items-center shadow">' +
            '<i class="fas fa-bus w-8"></i> Cetak AKDP</button>' +

            '<button onclick="printByCategory(\'AKAP\')" class="bg-orange-600 text-white py-3 px-4 rounded hover:bg-orange-700 transition flex items-center shadow">' +
            '<i class="fas fa-bus-alt w-8"></i> Cetak AKAP</button>' +

            '<button onclick="printByCategory(\'available\')" class="bg-teal-600 text-white py-3 px-4 rounded hover:bg-teal-700 transition flex items-center shadow">' +
            '<i class="fas fa-check-circle w-8"></i> Cetak Bus Tersedia</button>' +

            '<button onclick="printByCategory(\'unavailable\')" class="bg-red-600 text-white py-3 px-4 rounded hover:bg-red-700 transition flex items-center shadow">' +
            '<i class="fas fa-times-circle w-8"></i> Cetak Bus Tidak Tersedia</button>' +
            '</div>',
        showCloseButton: true,
        showConfirmButton: false,
        focusConfirm: false
    });
}    
        
        

        function printByCategory(category) {
            Swal.close(); 
            
            let dataToPrint = [];
            let categoryName = 'Semua Data';
            
            if (category === 'all') {
                dataToPrint = scheduleData;
                categoryName = 'Semua Jadwal';
            } else if (category === 'AKDP' || category === 'AKAP') {
                dataToPrint = scheduleData.filter(item => item.type === category);
                categoryName = 'Kategori ' + category;
            } else if (category === 'available') {
                dataToPrint = scheduleData.filter(item => item.busName && item.busName.trim() !== '');
                categoryName = 'Jadwal Tersedia';
            } else if (category === 'unavailable') {
                dataToPrint = scheduleData.filter(item => !item.busName || item.busName.trim() === '');
                categoryName = 'Jadwal Tidak Tersedia';
            }

            if (dataToPrint.length === 0) {
                Swal.fire('Info', 'Tidak ada data untuk kategori ini.', 'info');
                return;
            }

            // Menggunakan jsPDF untuk generate PDF otomatis
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

            // Header PDF
            doc.setFontSize(16);
            doc.setTextColor(30, 58, 138); // Blue 900
            doc.text("Jadwal Pemberangkatan Bis - TTA Sukabumi", 14, 15);
            
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Laporan: ${categoryName}`, 14, 22);
            doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 14, 27);

            // Persiapan Data Tabel
            const tableRows = dataToPrint.map((item, index) => {
                let displayTime = item.timeStart || item.time || '';
                if (item.timeEnd) displayTime += ' s/d ' + item.timeEnd;
                displayTime += ' WIB';

                const fare = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(item.fare);
                const status = (item.busName && item.busName.trim() !== '') ? 'Tersedia' : 'Tidak Tersedia';

                return [
                    index + 1,
                    item.route,
                    item.busName || '-',
                    displayTime,
                    fare,
                    item.type,
                    status,
                    item.description || '-'
                ];
            });

            // Generate Tabel
            doc.autoTable({
                head: [['No', 'Jurusan', 'Nama Bus', 'Jam', 'Tarif', 'Tipe', 'Status', 'Ket']],
                body: tableRows,
                startY: 32,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [30, 58, 138], textColor: 255, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [243, 244, 246] },
            });

            // Footer PDF
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Satuan Pelayanan Terminal Tipe A Sukabumi', 14, doc.internal.pageSize.height - 10);
                doc.text('Halaman ' + i + ' dari ' + pageCount, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
            }

            // Download
            doc.save(`Jadwal_TTA_Sukabumi_${category}_${Date.now()}.pdf`);

            Swal.fire({
                icon: 'success',
                title: 'PDF Berhasil Dibuat',
                text: 'File PDF telah diunduh otomatis.',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // No Auto Render on Load anymore, waits for Login
        // document.addEventListener('DOMContentLoaded', () => { renderCards(); });

    </script>
</body>
</html>
